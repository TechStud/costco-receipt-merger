<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costco Receipt Merger</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 900px;
            width: 100%;
            padding: 40px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .drop-zone {
            border: 3px dashed #667eea;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9ff;
            cursor: pointer;
            margin-bottom: 30px;
        }

        .drop-zone:hover, .drop-zone.drag-over {
            border-color: #764ba2;
            background: #f0f2ff;
            transform: scale(1.02);
        }

        .drop-zone-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .drop-zone-text {
            color: #666;
            font-size: 16px;
        }

        .file-list {
            margin-bottom: 20px;
        }

        .file-item {
            background: #f5f5f5;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .file-item:hover {
            background: #ebebeb;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-icon {
            font-size: 24px;
        }

        .file-details {
            display: flex;
            flex-direction: column;
        }

        .file-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .file-stats {
            font-size: 12px;
            color: #666;
        }

        .remove-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s ease;
        }

        .remove-btn:hover {
            background: #ff3838;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats-panel {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .stats-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .log-panel {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            display: none;
        }

        .log-panel.visible {
            display: block;
        }

        .log-entry {
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .log-success { color: #4ec9b0; }
        .log-warning { color: #dcdcaa; }
        .log-error { color: #f48771; }
        .log-info { color: #569cd6; }

        .hidden {
            display: none;
        }

        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßæ Costco Receipt Merger</h1>
        <p class="subtitle">Merge multiple of your Costco Receipt files (eg: Costco_In-Warehouse_Receipts_*.json) with intelligent deduplication and data completion.</p>

        <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">üìÅ</div>
            <div class="drop-zone-text">
                <strong>Drop your JSON formatted Costco Receipt files here</strong> or click to browse
            </div>
        </div>
        <input type="file" id="fileInput" accept=".json" multiple>

        <div class="file-list" id="fileList"></div>

        <div class="action-buttons">
            <button class="btn btn-secondary" id="clearBtn">Clear All</button>
            <button class="btn btn-primary" id="mergeBtn" disabled>Merge & Save</button>
        </div>

        <div class="stats-panel hidden" id="statsPanel">
            <div class="stats-title">üìä Merge Statistics</div>
            <div class="stats-grid" id="statsGrid"></div>
        </div>

        <div class="log-panel" id="logPanel"></div>
    </div>

    <script>
        // State management
        let loadedFiles = [];
        let allReceipts = [];

        // DOM elements
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const clearBtn = document.getElementById('clearBtn');
        const mergeBtn = document.getElementById('mergeBtn');
        const statsPanel = document.getElementById('statsPanel');
        const statsGrid = document.getElementById('statsGrid');
        const logPanel = document.getElementById('logPanel');

        // Logging utility
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logPanel.appendChild(entry);
            logPanel.scrollTop = logPanel.scrollHeight;
            logPanel.classList.add('visible');
        }

        // Deep merge function (same logic as fixed script)
        function deepMergeReceipts(oldReceipt, newReceipt) {
            const merged = { ...oldReceipt };
            
            for (const key in newReceipt) {
                const newVal = newReceipt[key];
                const oldVal = merged[key];
                
                if (newVal === null || newVal === undefined) continue;
                
                if (oldVal === null || oldVal === undefined) {
                    merged[key] = newVal;
                    continue;
                }
                
                if (Array.isArray(newVal)) {
                    if (!Array.isArray(oldVal) || newVal.length > oldVal.length) {
                        merged[key] = newVal;
                    } else if (newVal.length === oldVal.length && newVal.length > 0) {
                        merged[key] = oldVal.map((item, idx) => {
                            if (typeof item === 'object' && typeof newVal[idx] === 'object') {
                                return deepMergeReceipts(item, newVal[idx]);
                            }
                            return newVal[idx] !== null && newVal[idx] !== undefined ? newVal[idx] : item;
                        });
                    }
                    continue;
                }
                
                if (typeof newVal === 'object' && typeof oldVal === 'object') {
                    merged[key] = deepMergeReceipts(oldVal, newVal);
                    continue;
                }
                
                if (!oldVal || (typeof oldVal === 'string' && oldVal.trim() === '')) {
                    merged[key] = newVal;
                } else if (newVal && (typeof newVal !== 'string' || newVal.trim() !== '')) {
                    merged[key] = newVal;
                }
            }
            
            return merged;
        }

        // Calculate completeness score
        function calculateCompleteness(receipt) {
            let score = 0;
            let total = 0;
            
            const checkValue = (val) => {
                total++;
                if (val !== null && val !== undefined && val !== '') score++;
            };
            
            const mainFields = [
                'transactionBarcode', 'membershipNumber', 'transactionDateTime',
                'warehouseName', 'total', 'subTotal', 'taxes'
            ];
            mainFields.forEach(field => checkValue(receipt[field]));
            
            total++;
            if (Array.isArray(receipt.itemArray) && receipt.itemArray.length > 0) score++;
            
            total++;
            if (Array.isArray(receipt.tenderArray) && receipt.tenderArray.length > 0) score++;
            
            total++;
            if (receipt.subTaxes && typeof receipt.subTaxes === 'object' && Object.keys(receipt.subTaxes).length > 0) score++;
            
            return total > 0 ? (score / total) : 0;
        }

        // File handling
        dropZone.addEventListener('click', () => fileInput.click());
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(e.dataTransfer.files);
        });
        
        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        async function handleFiles(files) {
            for (const file of files) {
                if (file.type !== 'application/json' && !file.name.endsWith('.json')) {
                    log(`Skipped ${file.name} (not a JSON file)`, 'warning');
                    continue;
                }
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    if (!Array.isArray(data)) {
                        log(`Error: ${file.name} is not an array of receipts`, 'error');
                        continue;
                    }
                    
                    loadedFiles.push({
                        name: file.name,
                        receipts: data,
                        count: data.length
                    });
                    
                    log(`Loaded ${file.name} with ${data.length} receipts`, 'success');
                } catch (err) {
                    log(`Error parsing ${file.name}: ${err.message}`, 'error');
                }
            }
            
            updateUI();
        }

        function updateUI() {
            fileList.innerHTML = '';
            
            loadedFiles.forEach((file, index) => {
                const item = document.createElement('div');
                item.className = 'file-item';
                item.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">üìÑ</div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-stats">${file.count} receipts</div>
                        </div>
                    </div>
                    <button class="remove-btn" onclick="removeFile(${index})">Remove</button>
                `;
                fileList.appendChild(item);
            });
            
            mergeBtn.disabled = loadedFiles.length < 2;
        }

        window.removeFile = function(index) {
            log(`Removed ${loadedFiles[index].name}`, 'info');
            loadedFiles.splice(index, 1);
            updateUI();
            if (loadedFiles.length === 0) {
                statsPanel.classList.add('hidden');
            }
        };

        clearBtn.addEventListener('click', () => {
            loadedFiles = [];
            allReceipts = [];
            logPanel.innerHTML = '';
            logPanel.classList.remove('visible');
            statsPanel.classList.add('hidden');
            updateUI();
            log('Cleared all files', 'info');
        });

        mergeBtn.addEventListener('click', () => {
            log('Starting merge process...', 'info');
            mergeReceipts();
        });

        function mergeReceipts() {
            const receiptMap = new Map();
            let totalInputReceipts = 0;
            let receiptsUpdated = 0;
            let duplicatesSkipped = 0;
            let newReceipts = 0;
            const memberStats = new Map();

            // Collect all receipts
            const allReceiptsArray = [];
            loadedFiles.forEach(file => {
                totalInputReceipts += file.count;
                allReceiptsArray.push(...file.receipts);
            });

            log(`Processing ${totalInputReceipts} receipts from ${loadedFiles.length} files...`, 'info');

            // Process receipts
            allReceiptsArray.forEach((receipt, idx) => {
                const memberId = receipt.membershipNumber || 'UNKNOWN';
                
                if (!receipt.transactionBarcode || receipt.transactionBarcode.length < 15) {
                    duplicatesSkipped++;
                    return;
                }
                
                const uniqueKey = `${memberId}-${receipt.transactionBarcode}`;
                
                // Initialize member stats
                if (!memberStats.has(memberId)) {
                    memberStats.set(memberId, { total: 0, updated: 0, new: 0 });
                }
                
                if (receiptMap.has(uniqueKey)) {
                    const existing = receiptMap.get(uniqueKey);
                    const oldReceipt = existing.receipt;
                    
                    const oldScore = calculateCompleteness(oldReceipt);
                    const newScore = calculateCompleteness(receipt);
                    
                    const mergedReceipt = deepMergeReceipts(oldReceipt, receipt);
                    const mergedScore = calculateCompleteness(mergedReceipt);
                    
                    if (mergedScore > oldScore || JSON.stringify(mergedReceipt) !== JSON.stringify(oldReceipt)) {
                        receiptMap.set(uniqueKey, { receipt: mergedReceipt });
                        receiptsUpdated++;
                        memberStats.get(memberId).updated++;
                        log(`Updated receipt ${receipt.transactionBarcode} (completeness: ${(oldScore*100).toFixed(0)}% ‚Üí ${(mergedScore*100).toFixed(0)}%)`, 'success');
                    } else {
                        duplicatesSkipped++;
                    }
                } else {
                    receiptMap.set(uniqueKey, { receipt });
                    newReceipts++;
                    memberStats.get(memberId).new++;
                }
                
                memberStats.get(memberId).total++;
            });

            const finalReceipts = Array.from(receiptMap.values()).map(item => item.receipt);
            
            // Sort chronologically
            finalReceipts.sort((a, b) => new Date(a.transactionDateTime) - new Date(b.transactionDateTime));

            log(`Merge complete! ${finalReceipts.length} unique receipts`, 'success');
            log(`  - ${newReceipts} new receipts`, 'info');
            log(`  - ${receiptsUpdated} receipts updated with missing data`, 'info');
            log(`  - ${duplicatesSkipped} exact duplicates skipped`, 'info');

            // Display statistics
            displayStats({
                totalInput: totalInputReceipts,
                totalFiles: loadedFiles.length,
                finalCount: finalReceipts.length,
                updated: receiptsUpdated,
                newReceipts: newReceipts,
                duplicates: duplicatesSkipped,
                members: memberStats.size
            });

            // Download
            downloadMergedFile(finalReceipts);
        }

        function displayStats(stats) {
            statsGrid.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Total Files</div>
                    <div class="stat-value">${stats.totalFiles}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Input Receipts</div>
                    <div class="stat-value">${stats.totalInput}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Final Unique</div>
                    <div class="stat-value">${stats.finalCount}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Updated</div>
                    <div class="stat-value">${stats.updated}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">New Added</div>
                    <div class="stat-value">${stats.newReceipts}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Duplicates</div>
                    <div class="stat-value">${stats.duplicates}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Members</div>
                    <div class="stat-value">${stats.members}</div>
                </div>
            `;
            statsPanel.classList.remove('hidden');
        }

        async function downloadMergedFile(receipts) {
            const memberIds = [...new Set(receipts.map(r => r.membershipNumber).filter(Boolean))];
            let filename = 'Costco_Receipts_MERGED.json';
            
            if (memberIds.length === 1) {
                filename = `Costco_Receipts_${memberIds[0]}_MERGED.json`;
            } else if (memberIds.length > 1) {
                filename = `Costco_Receipts_${memberIds.length}-Members_MERGED.json`;
            }

            const dataStr = JSON.stringify(receipts, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });

            try {
                if ('showSaveFilePicker' in window) {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: filename,
                        types: [{
                            description: 'JSON File',
                            accept: { 'application/json': ['.json'] }
                        }]
                    });

                    const writable = await handle.createWritable();
                    await writable.write(blob);
                    await writable.close();
                    log(`Saved as: ${handle.name}`, 'success');
                } else {
                    throw new Error("File System Access API not supported");
                }
            } catch (err) {
                if (err.name !== 'AbortError') {
                    const a = document.createElement('a');
                    a.download = filename;
                    a.href = window.URL.createObjectURL(blob);
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(a.href);
                    log(`Downloaded as: ${filename}`, 'success');
                }
            }
        }
    </script>
</body>
</html>
