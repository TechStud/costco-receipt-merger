<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      min-height:100vh;padding:20px;display:flex;justify-content:center;align-items:center
    }
    .container{
      background:#fff;border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.3);
      max-width:900px;width:100%;padding:40px
    }
    h1{color:#333;margin-bottom:6px;font-size:28px}
    .subtitle{color:#666;margin-bottom:24px;font-size:14px}

    .intro-panel{
      background:#f7f8ff;
      border-left:4px solid #667eea;
      padding:14px 16px;
      margin-bottom:24px;
      border-radius:8px
    }
    .intro-text{
      font-size:14px;
      color:#444;
      margin-bottom:8px;
      line-height:1.5
    }
    .intro-steps{
      padding-left:18px;
      font-size:13px;
      color:#555
    }
    .intro-steps li{margin:4px 0}

    .drop-zone{
      border:3px dashed #667eea;border-radius:12px;padding:60px 20px;text-align:center;
      background:#f8f9ff;cursor:pointer;margin-bottom:30px;transition:.3s
    }
    .drop-zone.drag-over{border-color:#764ba2;background:#f0f2ff;transform:scale(1.02)}
    .drop-zone-icon{font-size:48px;margin-bottom:12px}
    .file-list{margin-bottom:20px}

    .file-info{
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .file-name{
      font-weight:600;
      color:#333;
    }

    .file-meta{
      font-size:12px;
      color:#666;
      display:flex;
      align-items:center;
      gap:6px;
    }

    .meta-count{
      min-width:90px; /* column alignment */
    }

    .meta-sep{
      opacity:0.6;
    }

    .meta-dates{
      font-family:monospace;
    }


    .file-item{
      background:#f5f5f5;padding:12px 16px;border-radius:8px;
      display:flex;justify-content:space-between;align-items:center;margin-bottom:8px
    }
    .remove-btn{
      background:#ff4757;color:#fff;border:none;padding:6px 12px;border-radius:6px;
      cursor:pointer;font-size:12px
    }

    .progress-hint{
      margin-top:12px;
      font-size:13px;
      color:#555;
      display:none
    }
    .progress-hint.visible{display:block}

    .action-buttons{display:flex;gap:12px;margin-top:20px}
    .btn{flex:1;padding:14px;border:none;border-radius:8px;font-size:16px;font-weight:600}
    .btn-primary{background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}
    .btn-secondary{background:#eee}
    .btn:disabled{opacity:.5}

    .stats-panel{margin-top:20px;display:none}
    .log-panel{
      background:#1e1e1e;color:#d4d4d4;margin-top:20px;padding:16px;
      border-radius:8px;font-family:monospace;font-size:13px;max-height:300px;overflow:auto;display:none;white-space: pre-wrap;
    }
    .log-panel.visible{display:block}
    .log-success{color:#4ec9b0}
    .log-warning{color:#dcdcaa}
    .log-error{color:#f48771}
    .log-info{color:#569cd6}
    input[type=file]{display:none}
  </style>
</head>

<body>
  <div class="container">
    <h1 id="documentTitle"></h1>
    <p class="subtitle">A browser-based tool for intelligently merging multiple local Costco receipt JSON files.</p>
    <div class="intro-panel">
      <p class="intro-text">
        This tool combines multiple Costco receipt JSON files into a single, clean, consolidated file.
        Duplicate receipts are safely merged, all available data is preserved, and the output is
        standardized for long-term storage or analysis.
      </p>

      <ol class="intro-steps">
        <li>Add <strong>two or more</strong> Costco receipt JSON files</li>
        <li>Review the selected files</li>
        <li>Click <strong>Merge &amp; Save</strong> to download the merged file</li>
      </ol>
    </div>

    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-icon">üìÅ</div>
      <strong>Drop Costco receipt JSON files here</strong><br/>or click to browse
    </div>
    <input type="file" id="fileInput" accept=".json" multiple>

    <div class="file-list" id="fileList"></div>

    <div class="action-buttons">
      <button class="btn btn-secondary" id="clearBtn">Clear</button>
      <button class="btn btn-primary" id="mergeBtn" disabled>Merge & Save</button>
    </div>
    <div class="progress-hint" id="progressHint">
      Processing receipts‚Ä¶ please wait.
    </div>

    <div class="stats-panel" id="statsPanel"></div>
    <div class="log-panel" id="logPanel"></div>
  </div>

  <script>
    const appVersion = '0.2.3';
    document.title = `Costco Receipt Merger v${appVersion}`;
    const titleElement = document.getElementById('documentTitle');
    titleElement.textContent = `üßæ ${document.title}`;

// ===============================
// Canonical Schema (LOCKED)
// ===============================

    const CANONICAL_RECEIPT = () => ({
      documentType:null,
      receiptType:null,
      membershipNumber:null,
      transactionType:null,
      transactionDateTime:null,
      transactionDate:null,
      warehouseShortName:null,
      warehouseNumber:null,
      warehouseName:null,
      warehouseAddress1:null,
      warehouseAddress2:null,
      warehouseCity:null,
      warehouseState:null,
      warehouseCountry:null,
      warehousePostalCode:null,
      warehouseAreaCode:null,
      warehousePhone:null,
      companyNumber:null,
      invoiceNumber: null,
      sequenceNumber: null,
      transactionBarcode:null,
      totalItemCount:null,
      instantSavings:null,
      subTotal:null,
      taxes:null,
      total:null,
      registerNumber:null,
      transactionNumber:null,
      operatorNumber:null,
      itemArray:[],
      couponArray:[],
      subTaxes:CANONICAL_SUBTAXES(),
      tenderArray:[]
    });

    const CANONICAL_ITEM = () => ({
      itemNumber:null,
      itemUPCNumber:null,
      itemDescription01:null,
      itemDescription02:null,
      frenchItemDescription1:null,
      frenchItemDescription2:null,
      itemIdentifier:null,
      itemDepartmentNumber:null,
      transDepartmentNumber:null,
      itemUnitPriceAmount:null,
      unit:null,
      amount:null,
      taxFlag:null,
      refundFlag:null,
      resaleFlag:null,
      voidFlag:null,
      merchantID:null,
      entryMethod:null,
      fuelUnitQuantity:null,
      fuelUomCode:null,
      fuelUomDescription:null,
      fuelUomDescriptionFr:null,
      fuelGradeCode:null,
      fuelGradeDescription:null,
      fuelGradeDescriptionFr:null
    });

    const CANONICAL_COUPON = () => ({
      couponNumber:null,
      upcnumberCoupon:null,
      associatedItemNumber:null,
      unitCoupon:null,
      amountCoupon:null,
      taxflagCoupon:null,
      voidflagCoupon:null,
      refundflagCoupon:null
    });

    const CANONICAL_SUBTAXES = () => ({
      tax1:null,
      tax2:null,
      tax3:null,
      tax4:null,
      aTaxPercent:null,
      aTaxLegend:null,
      aTaxAmount:null,
      aTaxPrintCode:null,
      aTaxPrintCodeFR:null,
      aTaxIdentifierCode:null,
      bTaxPercent:null,
      bTaxLegend:null,
      bTaxAmount:null,
      bTaxPrintCode:null,
      bTaxPrintCodeFR:null,
      bTaxIdentifierCode:null,
      cTaxPercent:null,
      cTaxLegend:null,
      cTaxAmount:null,
      cTaxIdentifierCode:null,
      dTaxPercent:null,
      dTaxLegend:null,
      dTaxAmount:null,
      dTaxPrintCode:null,
      dTaxPrintCodeFR:null,
      dTaxIdentifierCode:null,
      uTaxLegend:null,
      uTaxAmount:null,
      uTaxableAmount:null
    });

    const CANONICAL_TENDER = () => ({
      tenderTypeCode:null,
      tenderSubTypeCode:null,
      tenderTypeName:null,
      tenderTypeNameFr:null,
      tenderDescription:null,
      amountTender:null,
      displayAccountNumber:null,
      sequenceNumber:null,
      approvalNumber:null,
      responseCode:null,
      transactionID:null,
      merchantID:null,
      entryMethod:null,
      tenderAcctTxnNumber:null,
      tenderAuthorizationCode:null,
      tenderEntryMethodDescription:null,
      walletType:null,
      walletId:null,
      storedValueBucket: null
    });

// ===============================
// Utilities
// ===============================
    const logPanel=document.getElementById('logPanel');
    
    function log(msg,type='info'){
      const d=document.createElement('div');
      d.className=`log-${type}`;
      d.textContent=`[${new Date().toLocaleTimeString()}] ${msg}`;
      logPanel.appendChild(d);
      logPanel.classList.add('visible');
      logPanel.scrollTop=logPanel.scrollHeight;
    }

// ===============================
// LOSSLESS MERGE HELPERS
// ===============================

    function mergeScalars(a, b){
      if (a === undefined) return b;
      if (b === undefined) return a;
      if (a === null) return b;
      if (b === null) return a;
  return a; // deterministic: first wins if both real
}

function mergeObjects(a={}, b={}){
  const out = {...a};
  for(const k in b){
    if(!(k in out)){
      out[k] = b[k];
    } else if(
      typeof out[k] === 'object' && out[k] !== null &&
      typeof b[k] === 'object' && b[k] !== null &&
      !Array.isArray(out[k])
      ){
      out[k] = mergeObjects(out[k], b[k]);
    } else {
      out[k] = mergeScalars(out[k], b[k]);
    }
  }
  return out;
}

function mergeIdentityArray(a=[], b=[], idKey){
  const map = new Map();
  [...a, ...b].forEach(item=>{
    const id = item?.[idKey];
    if(id == null) return;
    if(!map.has(id)){
      map.set(id, {...item});
    } else {
      map.set(id, mergeObjects(map.get(id), item));
    }
  });
  return [...map.values()];
}

function mergeReceipt(a={}, b={}){
  const out = {...a};

  for(const k in b){
    if(Array.isArray(b[k])){
      if(k === 'itemArray'){
        // Preserve raw order & adjacency ‚Äî concat only
        out[k] = [...(out[k] || []), ...b[k]];
      } else if(k === 'couponArray'){
        out[k] = mergeIdentityArray(out[k], b[k], 'upcnumberCoupon');
      } else if(k === 'tenderArray'){
        out[k] = mergeIdentityArray(out[k], b[k], 'tenderTypeCode');
      } else {
        out[k] = [...(out[k] || []), ...b[k]];
      }
    }
    else if(typeof b[k] === 'object' && b[k] !== null){
      out[k] = mergeObjects(out[k] || {}, b[k]);
    }
    else {
      out[k] = mergeScalars(out[k], b[k]);
    }
  }

  return out;
}

// ==================================
// CANONICAL NORMALIZATION (TERMINAL)
// ==================================
function normalizeObject(source, canonical){
  const out = canonical();
  for(const k in out){
    if(Array.isArray(out[k])) continue;
    if(typeof out[k]==='object' && out[k]!==null){
      out[k]=normalizeObject(source?.[k]||{},()=>out[k]);
    } else {
      out[k]=(source && source[k]!==undefined)?source[k]:null;
    }
  }
  return out;
}

function normalizeArray(arr, canonical, idKey){
  if(!Array.isArray(arr)) return [];
  const map=new Map();
  arr.forEach(o=>{
    const id=o?.[idKey];
    if(id==null) return;
    map.set(id, normalizeObject(o, canonical));
  });
  return [...map.values()];
}

function normalizeReceipt(r){
  const out=normalizeObject(r,CANONICAL_RECEIPT);
  out.itemArray=normalizeArray(r.itemArray,CANONICAL_ITEM,'itemNumber');
  out.couponArray=normalizeArray(r.couponArray,CANONICAL_COUPON,'upcnumberCoupon');
  out.subTaxes=normalizeObject(r.subTaxes,CANONICAL_SUBTAXES);
  out.tenderArray=normalizeArray(r.tenderArray,CANONICAL_TENDER,'tenderTypeCode');
  return out;
}

// ===============================
// File Handling & Merge
// ===============================
const dropZone=document.getElementById('dropZone');
const fileInput=document.getElementById('fileInput');
const fileList=document.getElementById('fileList');
const mergeBtn=document.getElementById('mergeBtn');
const clearBtn=document.getElementById('clearBtn');
const progressHint=document.getElementById('progressHint');
let files=[];

dropZone.onclick=()=>fileInput.click();
dropZone.ondragover=e=>{e.preventDefault();dropZone.classList.add('drag-over')};
dropZone.ondragleave=()=>dropZone.classList.remove('drag-over');
dropZone.ondrop=e=>{
  e.preventDefault();dropZone.classList.remove('drag-over');
  handleFiles(e.dataTransfer.files);
};

fileInput.onchange = async e => {
  await handleFiles(e.target.files);
  e.target.value = '';
};

function getReceiptDateRange(receipts){
  let min = null;
  let max = null;

  receipts.forEach(r => {
    if (!r.transactionDateTime) return;
    const d = new Date(r.transactionDateTime);
    if (isNaN(d)) return;

    if (!min || d < min) min = d;
    if (!max || d > max) max = d;
  });

  const fmt = d => d.toISOString().slice(0,10);

  return {
    minDate: min ? fmt(min) : null,
    maxDate: max ? fmt(max) : null
  };
}


async function handleFiles(flist){
  for(const f of flist){
    try {
      const data=JSON.parse(await f.text());

      if (!Array.isArray(data)) throw new Error('Not a receipt array');

      if (files.some(x => x.name === f.name)) {
        log(`File already added: ${f.name}`, 'warning');
        continue;
      }

      files.push({name:f.name,data});
      const d=document.createElement('div');
      d.className='file-item';

      const { minDate, maxDate } = getReceiptDateRange(data);

      d.innerHTML = `
  <div class="file-info">
    <div class="file-name">${f.name}</div>
    <div class="file-meta">
      <span class="meta-count"> <b>‚Ü≥</b> ${data.length} receipts</span>
      <span class="meta-sep">¬∑</span>
      <span class="meta-dates">
        ${minDate && maxDate ? `${minDate} ‚Üí ${maxDate}` : 'Date range unavailable'}
      </span>
    </div>
  </div>
  <button class="remove-btn">Remove</button>
      `;


      d.querySelector('button').onclick=()=>{
        files=files.filter(x=>x.name!==f.name);
        d.remove();
      };
      fileList.appendChild(d);
    } catch (e) {
      log(`Failed to load ${f.name}: ${e.message}`, 'error');
    }
  }
  mergeBtn.disabled=files.length<2;
}

clearBtn.onclick = () => {
  files = [];
  fileList.innerHTML = '';

  logPanel.innerHTML = '';
  logPanel.classList.remove('visible');
  progressHint.classList.remove('visible');
  mergeBtn.disabled = true;
};

mergeBtn.onclick=()=>{
  logPanel.innerHTML='';
  logPanel.classList.remove('visible');
  progressHint.classList.add('visible');

  log('Merge started','info');
  log(`Total receipt files selected: ${files.length}`,'info');

  log('', 'info');

  files.forEach((f, idx) => {
    const { minDate, maxDate } = getReceiptDateRange(f.data);

    const idxStr = String(idx + 1).padStart(2, ' ');
    const cntStr = String(f.data.length).padStart(5, ' ');

    log(` ${idxStr}. ${f.name}`, 'info');
    log(`     ‚Ü≥ ${cntStr} Receipts ¬∑ ${minDate && maxDate ? `${minDate} ‚Üí ${maxDate}` : 'Date range unavailable'}`,'info');
    log('', 'info');
  });
  
  const map=new Map();
  let skipped=0;
  let totalInput = 0;

  files.forEach((f, idx) => {
    f.data.forEach(r=>{
      totalInput++;
      if(!r.transactionBarcode){skipped++;return;}

      const key = r.membershipNumber + '-' + r.transactionBarcode;
      if(!map.has(key)){
        map.set(key, {...r});
      } else {
        map.set(key, mergeReceipt(map.get(key), r));
      }
    });
  });

  // log('', 'info');
  log(`Total receipts across all files: ${totalInput}`,'info');

  if(skipped){
    log(`Skipped ${skipped} receipts: Missing transactionBarcode`,'warning');
  }

  log(`Merged into ${map.size} unique receipts`,'info');

  const normalized = [...map.values()].map(normalizeReceipt);

  // Sort Receipts Oldest -> Newest
  normalized.sort((a, b) => {
    if (!a.transactionDateTime && !b.transactionDateTime) return 0;
    if (!a.transactionDateTime) return 1;
    if (!b.transactionDateTime) return -1;
    return new Date(a.transactionDateTime) - new Date(b.transactionDateTime);
  });
  log('', 'info');
  log('Merge complete','success');
  log(` ‚Ü≥ ${map.size} unique receipts produced`,'success');
  progressHint.classList.remove('visible');
  mergeBtn.disabled = true;
  download(normalized);
};

function download(data){
  const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  const today = new Date().toISOString().slice(0,10);
  a.download = `Costco_Receipts_MERGED_${today}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  log(` ‚Ü≥ Output file: ${a.download}`,'success');
}
</script>
</body>
</html>
